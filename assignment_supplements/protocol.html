<h1>Publish/Subscribe Protocol</h1>

<p>This document describes the protocol governing the communication between
server and clients for NSD assignments 2 and 3. The document first
details the order of exchanges dictated by the protocol. Then the
format of individual requests and responses is specified (by examples).</p>

<h3>Order of exchanges (per session)</h3>

<ol>
<li>Client sends Open request, identifying the channel to publish on.</li>
<li>Server responds with Success.</li>
<li>Client sends Publish, Subscribe, Unsubscribe or Get request.</li>
<li>In case of Get, server responds with MessageList,
otherwise server responds with Success or Error.</li>
<li>Go to 3.</li>
</ol>

<h3>JSON encoding</h3>

<p>All client/server exchanges (as well as the messages contained within)
are encoded as JSON objects. All these objects have a mandatory field
<code>_class</code>, the String value of which indicates the type of object.
JSON-encoded requests and responses are transmitted as single lines of
text.</p>

<h3>Messages</h3>

<p>A message is encoded as a JSON object with fields <code>from</code> (the
sender of the message), <code>when</code> (a non-negative integer serving as
the timestamp when the message was received by the server) and
<code>body</code> (the text of the message).</p>

<p><code>
{"_class":"Message", "from":"Bob", "when":47, "body":"Hello again!"}
</code></p>

<p>Beyond these fields, a message may have additional fields, such as
the field <code>pic</code> below (for a picture attachment, base64-encoded).</p>

<p><code>
{"_class":"Message", "from":"Alice", "when":53, "body":"pic attached, base64 encoded, LOL", "pic":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAxlBMVEUAAADWAEX/"}
</code></p>

<h3>Requests</h3>

<p>The server understands 5 types of requests. All requests include
an <code>identity</code> field identifying the channel associated with
the client.</p>

<ul>
<li><p>An <strong>Open</strong> request establishes the client's identity and creates a
channel by that name if it does not already exist. The request
also subscribes the client to its own channel. The request
always succeeds.</p>

<p><code>{"_class":"OpenRequest", "identity":"Alice"}</code></p></li>
<li><p>A <strong>Publish</strong> request publishes a message on the client's channel.
The timestamp of the message is ignored; the server will issue
its own timestamp for the message when storing it.
The request fails if the channel does not exist or
if the message is too big.</p>

<p><code>{"_class":"PublishRequest", "identity":"Alice", "message":{"_class":"Message", "from":"Bob", "when":0, "body":"Hello again!"}}</code></p></li>
<li><p>A <strong>Subscribe</strong> request subscribes the client to the named channel.
The request fails if the channel does not exist.</p>

<p><code>{"_class":"SubscribeRequest", "identity":"Alice", "channel":"Bob"}</code></p></li>
<li><p>An <strong>Unsubscribe</strong> request unsubscribes the client from the named
channel. The request fails if the channel does not exist.</p>

<p><code>{"_class":"UnsubscribeRequest", "identity":"Alice", "channel":"Bob"}</code></p></li>
<li><p>A <strong>Get</strong> request retrieves all messages that were published on any
channel to which the client is currently subscribed, in the order in
which they were published. The field <code>after</code> specifies a
timestamp, and the server will only retrieve messages that were
published strictly after that timestamp. If the timestamp is 0 the
server will retrieve all messages from the subscribed channels.  The
request never fails, but it may return an empty list of messages.</p>

<p><code>{"_class":"GetRequest", "identity":"Alice", "after":42}</code></p></li>
</ul>

<h3>Responses</h3>

<p>The server replies to requests with 3 types of responses.</p>

<ul>
<li><p>A <strong>Success</strong> response simply indicates that the request succeeded.</p>

<p><code>{"_class":"SuccessResponse"}</code></p></li>
<li><p>An <strong>Error</strong> response indicates that the request failed
and provides a reason why.</p>

<p><code>{"_class":"ErrorResponse", "error":"NO SUCH CHANNEL: Bob"} <br>
{"_class":"ErrorResponse", "error":"MESSAGE TOO BIG: 1234 characters"} <br>
{"_class":"ErrorResponse", "error":"INVALID REQUEST: [{]"}</code></p></li>
<li><p>A <strong>MessageList</strong> response is sent in reply to a <strong>Get</strong> request.
The response provides a list of messages ordered by timestamp.
The list of messages may be empty.</p>

<p><code>{"_class":"MessageListResponse", "messages":[]} <br>
{"_class":"MessageListResponse", "messages":[{"_class":"Message", "from":"Bob", "when":47, "body":"Hello again!"}, {"_class":"Message", "from":"Alice", "when":53, "body":"pic attached, base64 encoded, LOL", "pic":"iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAxlBMVEUAAADWAEX/"}]}</code></p></li>
</ul>
